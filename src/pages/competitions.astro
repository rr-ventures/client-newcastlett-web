---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Competitions | Newcastle Table Tennis" description="Check the latest draws, results, and competition schedules for Newcastle Table Tennis Club.">
    <div class="bg-neutral-50 py-16 min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-10 text-center md:text-left md:flex md:items-end md:justify-between">
                <div>
                     <h1 class="text-4xl font-heading font-bold text-neutral-900 uppercase">Competition Draws</h1>
                     <p class="mt-2 text-neutral-600">View upcoming matches and current season standings.</p>
                </div>
                <div class="mt-4 md:mt-0 flex gap-4 justify-center md:justify-end">
                     <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTfoqDuKknGp_w8r1wJkO7jskQEeaSpuwS0qR2V-SN-c_SJTaCBG-OQUfTgpQldhq2bOOfBjm-fEYyK/pubhtml" target="_blank" class="inline-flex items-center px-4 py-2 border border-neutral-300 shadow-sm text-sm font-bold uppercase tracking-wide rounded text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-colors">
                        <svg class="mr-2 -ml-1 h-4 w-4 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Open Spreadsheet
                    </a>
                     <button id="refresh-btn" class="inline-flex items-center px-4 py-2 border border-neutral-300 shadow-sm text-sm font-bold uppercase tracking-wide rounded text-neutral-700 bg-white hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 transition-colors">
                        <svg class="mr-2 -ml-1 h-4 w-4 text-neutral-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
            
            <div class="bg-white shadow-sm overflow-hidden rounded-xl border border-neutral-200">
                <!-- Loading State -->
                <div id="loading" class="p-16 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-neutral-200 border-t-brand-600"></div>
                    <p class="mt-4 text-neutral-500 font-medium">Loading schedule...</p>
                </div>

                <!-- Error State -->
                <div id="error-message" class="hidden p-16 text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-neutral-900">Unable to load data</h3>
                    <p class="text-neutral-500 mt-2 max-w-sm mx-auto mb-6">
                        We couldn't fetch the latest competition data directly.
                    </p>
                    <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTfoqDuKknGp_w8r1wJkO7jskQEeaSpuwS0qR2V-SN-c_SJTaCBG-OQUfTgpQldhq2bOOfBjm-fEYyK/pubhtml" target="_blank" rel="noopener" class="text-brand-600 hover:text-brand-700 font-bold hover:underline uppercase tracking-wide text-sm">
                        View Spreadsheet Directly &rarr;
                    </a>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table id="comps-table" class="hidden min-w-full divide-y divide-neutral-200">
                        <thead class="bg-neutral-100">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-neutral-600 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-neutral-600 uppercase tracking-wider">Event</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-neutral-600 uppercase tracking-wider">Division</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-neutral-600 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-neutral-200" id="table-body">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <p class="text-center text-sm text-neutral-400 mt-6">
                Data is updated weekly. Contact the match secretary for corrections.
            </p>
        </div>
    </div>
</Layout>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTfoqDuKknGp_w8r1wJkO7jskQEeaSpuwS0qR2V-SN-c_SJTaCBG-OQUfTgpQldhq2bOOfBjm-fEYyK/pub?output=csv';

    async function fetchCompetitions() {
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('error-message');
        const table = document.getElementById('comps-table');
        const tableBody = document.getElementById('table-body');
        
        if (!loading || !errorMsg || !table || !tableBody) return;

        // Reset state
        loading.classList.remove('hidden');
        errorMsg.classList.add('hidden');
        table.classList.add('hidden');
        tableBody.innerHTML = '';

        try {
            const response = await fetch(SHEET_URL);
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const text = await response.text();
            
            // Basic CSV parser that handles quotes
            // Note: This is a simplified parser. For full RFC 4180 compliance, a library like PapaParse is recommended.
            // But we want to avoid external deps if possible.
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') {
                        currentField += '"';
                        i++; // Skip escaped quote
                    } else if (char === '"') {
                        inQuotes = false;
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        currentRow.push(currentField);
                        currentField = '';
                    } else if (char === '\n' || char === '\r') {
                        if (currentField || currentRow.length > 0) {
                            currentRow.push(currentField);
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                        if (char === '\r' && nextChar === '\n') i++; // Handle CRLF
                    } else {
                        currentField += char;
                    }
                }
            }
            // Add last row if exists
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                rows.push(currentRow);
            }

            // Filter out empty rows and header
            // We assume the first row with meaningful data is the header or data
            // Let's assume header is present if first row contains "Date" or similar
            let dataRows = rows.filter(r => r.length > 1 && r.some(cell => cell.trim() !== ''));
            
            // Remove header row if it looks like a header
            if (dataRows.length > 0 && (dataRows[0][0].toLowerCase().includes('date') || dataRows[0][1].toLowerCase().includes('event'))) {
                 dataRows = dataRows.slice(1);
            }

            if (dataRows.length === 0) {
                renderTable([]);
            } else {
                 renderTable(dataRows);
            }
            
            loading.classList.add('hidden');
            table.classList.remove('hidden');

        } catch (error) {
            console.warn('Competition fetch failed:', error);
            loading.classList.add('hidden');
            errorMsg.classList.remove('hidden');
        }
    }

    function renderTable(rows) {
        const tableBody = document.getElementById('table-body');
        if(!tableBody) return;

        if (rows.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-neutral-500">No active competitions scheduled at the moment.</td></tr>';
             return;
        }

        rows.forEach(row => {
            // Map columns safely (Date, Event, Division, Status)
            // Adjust indices based on your specific CSV structure if needed
            const date = row[0] || '';
            const name = row[1] || '';
            const division = row[2] || '';
            const status = row[3] || 'Closed';

            const statusText = status.trim();
            const isOpen = statusText.toLowerCase() === 'open';

            const tr = document.createElement('tr');
            tr.className = "hover:bg-neutral-50 transition-colors";
            
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-900 font-bold">${date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-900">${name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral-500">${division}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded text-xs font-bold uppercase tracking-wide ${isOpen ? 'bg-green-100 text-green-800' : 'bg-neutral-100 text-neutral-800'}">
                        ${statusText}
                    </span>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }

    document.addEventListener('DOMContentLoaded', fetchCompetitions);
    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', fetchCompetitions);
    }
</script>
